<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>親筆信 AI OCR + LibreTranslate 翻譯 + 手寫疊加圖片</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    #preview { max-width: 100%; margin-top: 10px; display:none; }
    #handwritingCanvas { border: 1px solid #ccc; margin-top: 20px; max-width: 100%; }
    #resultText { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-top: 10px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>親筆信 AI OCR + LibreTranslate 翻譯 + 手寫疊加圖片</h1>

  <label>拍照或上傳親筆信圖片：</label><br />
  <input type="file" id="imgInp" accept="image/*" capture="environment" />
  <br />
  <img id="preview" alt="圖片預覽" />
  <br />

  <label>選擇翻譯目標語言：</label>
  <select id="targetLang">
    <option value="en">英文</option>
    <option value="zh">中文</option>
    <option value="ja">日文</option>
    <option value="ko">韓文</option>
    <option value="fr">法文</option>
    <option value="es">西班牙文</option>
  </select>
  <br /><br />

  <button id="processBtn">開始轉寫與翻譯</button>
  <button id="downloadBtn" disabled>下載合成圖片</button>

  <h3>辨識文字（OCR）與翻譯結果：</h3>
  <pre id="resultText">尚未辨識</pre>

  <h3>合成圖片預覽：</h3>
  <canvas id="handwritingCanvas"></canvas>

  <!-- 引入 Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <script>
    const imgInp = document.getElementById('imgInp');
    const preview = document.getElementById('preview');
    const resultText = document.getElementById('resultText');
    const targetLang = document.getElementById('targetLang');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const canvas = document.getElementById('handwritingCanvas');
    const ctx = canvas.getContext('2d');

    let loadedImage = null;

    // 圖片上傳後顯示預覽並載入 Image 物件
    imgInp.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        preview.src = evt.target.result;
        preview.style.display = 'block';

        loadedImage = new Image();
        loadedImage.onload = () => {
          // 設定 Canvas 尺寸與圖片相同
          canvas.width = loadedImage.width;
          canvas.height = loadedImage.height;
          ctx.drawImage(loadedImage, 0, 0);
        };
        loadedImage.src = evt.target.result;
      };
      reader.readAsDataURL(file);
      downloadBtn.disabled = true;
      resultText.textContent = '尚未辨識';
    });

    // 用 LibreTranslate 進行翻譯（含自動語言偵測）
    async function translateText(text, target) {
      const res = await fetch('https://libretranslate.com/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          q: text,
          source: "auto",  // LibreTranslate 支援自動偵測來源語言
          target: target,
          format: "text"
        })
      });
      const data = await res.json();
      return data.translatedText;
    }

    // 在 Canvas 上疊加手寫風格文字，簡單換行
    function drawTextOverImage(text) {
      if (!loadedImage) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(loadedImage, 0, 0);

      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.font = "30px 'Segoe Script', 'Comic Sans MS', cursive, 'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo'";
      ctx.textBaseline = "top";

      const maxWidth = canvas.width - 40;
      const lineHeight = 40;
      let x = 20;
      let y = 20;

      const lines = text.split('\n');
      for (const line of lines) {
        let currentLine = '';
        for (const char of line) {
          const testLine = currentLine + char;
          const metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth) {
            ctx.fillText(currentLine, x, y);
            y += lineHeight;
            currentLine = char;
          } else {
            currentLine = testLine;
          }
        }
        ctx.fillText(currentLine, x, y);
        y += lineHeight;
      }
    }

    // 主流程：OCR 辨識 + LibreTranslate 翻譯 + 疊加文字
    processBtn.addEventListener('click', async () => {
      if (!imgInp.files.length) {
        alert("請先上傳圖片");
        return;
      }
      if (!loadedImage) {
        alert("圖片尚未載入完成，請稍候");
        return;
      }
      resultText.textContent = "辨識中，請稍候...";
      downloadBtn.disabled = true;

      const file = imgInp.files[0];
      try {
        // OCR 辨識，使用英文、繁體中文、韓文語言包
        const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_tra+kor', {
          logger: m => console.log(m)
        });
        resultText.textContent = "OCR 辨識結果:\n" + text.trim();

        // LibreTranslate 翻譯（自動偵測來源語言）
        const target = targetLang.value;
        const translated = await translateText(text.trim(), target);
        resultText.textContent += `\n\n翻譯結果 (${target}):\n` + translated;

        // 疊加文字
        drawTextOverImage(translated);

        downloadBtn.disabled = false;
      } catch (err) {
        resultText.textContent = "辨識或翻譯失敗，請重試。\n" + err.message;
      }
    });

    // 下載合成圖片
    downloadBtn.addEventListener('click', () => {
      const imageURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = imageURL;
      link.download = '親筆信_合成圖片.png';
      link.click();
    });
  </script>
</body>
</html>
