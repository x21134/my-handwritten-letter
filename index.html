<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>親筆信 AI 轉寫與手寫覆蓋圖片（含韓文）</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    #preview { max-width: 100%; margin-top: 10px; display:none; }
    #handwritingCanvas { border: 1px solid #ccc; margin-top: 20px; }
    #resultText { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-top: 10px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>親筆信 AI 轉寫與手寫覆蓋圖片（含韓文）</h1>

  <label>拍照或上傳親筆信圖片：</label><br />
  <input type="file" id="imgInp" accept="image/*" capture="environment" />
  <br />
  <img id="preview" alt="圖片預覽" />
  <br />

  <label>選擇翻譯目標語言：</label>
  <select id="targetLang">
    <option value="en">英文</option>
    <option value="zh-Hant">繁體中文</option>
    <option value="ja">日文</option>
    <option value="ko">韓文</option>
    <option value="fr">法文</option>
    <option value="es">西班牙文</option>
  </select>
  <br /><br />

  <button id="processBtn">開始轉寫與翻譯</button>
  <button id="downloadBtn" disabled>下載合成圖片</button>

  <h3>辨識文字（OCR）結果：</h3>
  <pre id="resultText">尚未辨識</pre>

  <h3>合成圖片預覽：</h3>
  <canvas id="handwritingCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <script>
    const imgInp = document.getElementById('imgInp');
    const preview = document.getElementById('preview');
    const resultText = document.getElementById('resultText');
    const targetLang = document.getElementById('targetLang');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const canvas = document.getElementById('handwritingCanvas');
    const ctx = canvas.getContext('2d');

    let loadedImage = null;

    // 圖片上傳後顯示預覽並儲存 Image 物件
    imgInp.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        preview.src = evt.target.result;
        preview.style.display = 'block';

        // 建立 Image 物件，等候載入完成後才能繪製到 Canvas
        loadedImage = new Image();
        loadedImage.onload = () => {
          // 設定 Canvas 尺寸與圖片相同
          canvas.width = loadedImage.width;
          canvas.height = loadedImage.height;
          clearCanvas();
          ctx.drawImage(loadedImage, 0, 0);
        };
        loadedImage.src = evt.target.result;
      };
      reader.readAsDataURL(file);
      downloadBtn.disabled = true;
    });

    // 清除 Canvas
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 在 Canvas 上疊加手寫風格文字，簡單換行
    function drawHandwritingOverImage(text) {
      if (!loadedImage) return;
      // 先畫原圖
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(loadedImage, 0, 0);

      // 文字樣式設定（可調整）
      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.font = "30px 'Segoe Script', 'Comic Sans MS', cursive, 'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo'";
      ctx.textBaseline = "top";

      const maxWidth = canvas.width - 40;
      const lineHeight = 40;
      let x = 20;
      let y = 20;

      const lines = text.split('\n');
      for (const line of lines) {
        let currentLine = '';
        for (const char of line) {
          const testLine = currentLine + char;
          const metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth) {
            ctx.fillText(currentLine, x, y);
            y += lineHeight;
            currentLine = char;
          } else {
            currentLine = testLine;
          }
        }
        ctx.fillText(currentLine, x, y);
        y += lineHeight;
      }
    }

    // 呼叫 MyMemory 免費翻譯 API
    async function translateText(text, target) {
      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=auto|${target}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        return data.responseData.translatedText;
      } catch (e) {
        return text; // 失敗回傳原文
      }
    }

    // 轉寫與翻譯按鈕事件
    processBtn.addEventListener('click', async () => {
      if (!imgInp.files.length) {
        alert("請先上傳圖片");
        return;
      }
      if (!loadedImage) {
        alert("圖片尚未載入完成，請稍候");
        return;
      }
      resultText.textContent = "辨識中，請稍候...";
      downloadBtn.disabled = true;

      const file = imgInp.files[0];
      try {
        // OCR 辨識，加入韓文語言包 kor
        const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_tra+kor', {
          logger: m => console.log(m)
        });
        resultText.textContent = "OCR 辨識結果:\n" + text.trim();

        // 翻譯
        const target = targetLang.value;
        let finalText = text.trim();
        if (target !== 'auto' && target !== 'eng') {
          const translated = await translateText(finalText, target);
          resultText.textContent += `\n\n翻譯結果 (${target}):\n` + translated;
          finalText = translated;
        }

        // 在圖片上疊加文字
        drawHandwritingOverImage(finalText);

        // 啟用下載按鈕
        downloadBtn.disabled = false;
      } catch (err) {
        resultText.textContent = "辨識失敗，請重試。\n" + err.message;
      }
    });

    // 下載合成圖片按鈕事件
    downloadBtn.addEventListener('click', () => {
      const imageURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = imageURL;
      link.download = '親筆信_合成圖片.png';
      link.click();
    });
  </script>
</body>
</html>
